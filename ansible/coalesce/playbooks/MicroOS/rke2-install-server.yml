- name: install rke2
  hosts: "server"
  tasks:
    - name: install qemu-guest-agent
      become: true
      command: transactional-update --non-interactive pkg in qemu-guest-agent
    - name: install rke2 server
      become: true
      command: transactional-update --continue run bash -c 'curl -sfL https://get.rke2.io | sh -'
    - name: add rke2 to path
      become: true
      command: transactional-update --continue run bash -c 'export PATH=$PATH:/opt/rke2/bin'
    - name: Reboot the nodes
      become: true
      reboot:
        reboot_timeout: 300
    - name: enable rke2-server service
      become: true
      command: transactional-update run bash -c 'systemctl enable rke2-server.service'
    - name: reboot the nodes
      become: true
      reboot:
        reboot_timeout: 300
    - name: obtain node-token
      ansible.builtin.fetch:
        src: /var/lib/rancher/rke2/server/node-token
        dest: autogenerated/node-token
        flat: yes
    - name: Find out what the remote machine's mounts are
      ansible.builtin.slurp:
        src: /var/lib/rancher/rke2/server/node-token
      register: node-token
    - name: Print returned information
      ansible.builtin.debug:
        msg: "{{ mounts['content']}}"
    - name: Print returned information
      ansible.builtin.debug:
        msg: "{{ mounts['content'] | b64decode }}"
