- name: Longhorn | Create filesystem on volume
  community.general.filesystem:
    fstype: ext4
    dev: "{{ LONGHORN_DISK_IDENTIFIER }}"

- name: Longhorn | Create mount point
  ansible.builtin.file:
    path: "/var/lib/longhorn"
    state: directory

- name: Longhorn | Mount volume
  ansible.builtin.mount:
    path: "/var/lib/longhorn"
    src: "{{ LONGHORN_DISK_IDENTIFIER }}"
    fstype: ext4
    opts: defaults
    state: mounted

- name: Longhorn | Add Helm repository
  delegate_to: localhost
  run_once: true
  kubernetes.core.helm_repository:
    kubeconfig: ./autogenerated/rke2-vip.yaml
    name: longhorn
    repo_url: https://charts.longhorn.io

- name: Longhorn | Add label to designate Longhorn node
  delegate_to: localhost
  kubernetes.core.k8s:
    kubeconfig: ./autogenerated/rke2-vip.yaml
    resource_definition:
      api_version: v1
      kind: Node
      metadata:
        name: "{{ inventory_hostname }}"
        labels:
          longhorn: "true"

- name: Longhorn | Install with Helm
  delegate_to: localhost
  run_once: true
  kubernetes.core.helm:
    kubeconfig: ./autogenerated/rke2-vip.yaml
    name: longhorn
    chart_ref: longhorn/longhorn
    release_namespace: longhorn-system
    create_namespace: true
    chart_version: v1.5.4
    values:
      ingress.enabled: true
      ingress.ingressClassName: traefik
      host: longhorn.k8s.{{ ROOT_DOMAIN }}
      defaultSettings:
        taintToleration: ":"
        systemManagedComponentsNodeSelector: "longhorn:true"
      longhornDriver.tolerations:
        - key: "CriticalAddonsOnly"
          operator: "Exists"
          effect: "NoSchedule"
      longhornManager.tolerations:
        - key: "CriticalAddonsOnly"
          operator: "Exists"
          effect: "NoSchedule"
