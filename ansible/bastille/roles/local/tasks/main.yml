- name: Run openSUSE Tasks
  ansible.builtin.import_tasks: suse.yml
  when: ansible_os_family == 'Suse'
  become: true

- name: Update kubeconfig with initial_server address
  ansible.builtin.copy:
    dest: ./autogenerated/rke2-initial.yaml
    content: "{{ lookup('file', './autogenerated/rke2.yaml') | regex_replace('127.0.0.1', '10.30.0.10') }}"
    mode: '0600'
    force: yes

- name: Update kubeconfig with kube-vip address
  ansible.builtin.copy:
    dest: ./autogenerated/rke2-vip.yaml
    content: "{{ lookup('file', './autogenerated/rke2.yaml') | regex_replace('127.0.0.1', '10.30.0.30') }}"
    mode: '0600'
    force: yes

- name: Add rancher-latest Helm repository
  kubernetes.core.helm_repository:
    kubeconfig: ./autogenerated/rke2-vip.yaml
    name: rancher-latest
    repo_url: https://releases.rancher.com/server-charts/latest

- name: Install Rancher with Helm
  kubernetes.core.helm:
    kubeconfig: ./autogenerated/rke2-vip.yaml
    name: rancher
    chart_ref: rancher-latest/rancher
    release_namespace: cattle-system
    create_namespace: true
    values:
      hostname: "rancher.{{ SERVER_ADDRESS_FQDN }}"
      bootstrapPassword: "{{ RANCHER_BOOTSTRAP_PASSWORD }}"
      ingress.tls.source: letsEncrypt
      letsEncrypt.email: "{{ LETS_ENCRYPT_EMAIL }}"
      letsEncrypt.ingress.class: traefik

- name: Create cattle-system namespace
  vars:
    ansible_python_interpreter: /usr/bin/python3
  kubernetes.core.k8s:
    kubeconfig: ./autogenerated/rke2-vip.yaml
    kind: Namespace
    api_version: v1
    name: cattle-system
    state: present

- name: Taint server nodes
  vars:
    ansible_python_interpreter: /usr/bin/python3
  kubernetes.core.k8s:
    api_version: v1
    kind: Node
    name: "{{ item }}"
    inline:
      spec:
        taints:
          - key: "Key"
            value: "Value"
            effect: "NoSchedule"
  loop: "{{ groups['initial_server'] + groups['additional_servers'] | flatten }}"