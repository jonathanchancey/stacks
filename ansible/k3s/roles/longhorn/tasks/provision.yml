---
- name: Longhorn | Install longhorn storage node dependencies
  apt:
    name:
      - fuse-overlayfs
    state: present
    update_cache: true

- name: Longhorn | Get disk information
  ansible.builtin.command: lsblk -d -o NAME,SIZE,VENDOR,MODEL
  register: disk_info
  changed_when: false

- name: Longhorn | Filter drives and create list
  ansible.builtin.set_fact:
    eligible_drives: "{{ disk_info.stdout_lines | select('match', longhorn_lvm_drive_match_string) | list }}"

- name: Longhorn | Create ext4 filesystem from filtered drives with label
  community.general.filesystem:
    fstype: ext4
    dev: "/dev/{{ item | regex_replace('^([^ ]+).*', '\\1') }}"
    opts: "-L longhorn{{ '%02d' | format(i) }}"
  loop: "{{ eligible_drives }}"
  loop_control:
    index_var: i
  when: eligible_drives | length > 0

- name: Longhorn | Create mount points
  ansible.builtin.file:
    path: "/var/lib/longhorn-{{ '%02d' | format(i) }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0755"
  loop: "{{ eligible_drives }}"
  loop_control:
    index_var: i
  when: eligible_drives | length > 0

- name: Longhorn | Add mount entries to /etc/fstab
  ansible.posix.mount:
    path: "/var/lib/longhorn-{{ '%02d' | format(i) }}"
    src: "LABEL=longhorn{{ '%02d' | format(i) }}"
    fstype: ext4
    state: mounted
    opts: defaults,nofail
  loop: "{{ eligible_drives }}"
  loop_control:
    index_var: i
  when: eligible_drives | length > 0
