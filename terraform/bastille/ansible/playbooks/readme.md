# ansible

## commands

```bash
# these commands are for an admin vm/lxc on the same vlan as the cluster

# clone and cd into ansible dir
git clone https://github.com/jonathanchancey/stacks 
cd stacks/terraform/bastille/ansible/

# install first server and generate node-token and rke2.yaml
ansible-playbook ./playbooks/rke2-install-server.yml --user root -i ./inventory/hosts

# make token readable in ansible
echo -n "TOKEN: " | cat - ./playbooks/autogenerated/node-token > ./playbooks/autogenerated/token

# split out multiple kubeconfigs for different stages of cluster creation
cat ./playbooks/autogenerated/rke2.yaml | sed 's/127.0.0.1/'10.30.0.10'/g' > ./playbooks/autogenerated/rke2-initial.yaml
chmod 600 playbooks/autogenerated/rke2-initial.yaml

cat ./playbooks/autogenerated/rke2.yaml | sed 's/127.0.0.1/'10.30.0.30'/g' > ./playbooks/autogenerated/rke2-vip.yaml
chmod 600 playbooks/autogenerated/rke2-vip.yaml

# export KUBECONFIG for this session, or add to ~/.bashrc to make changes permanent 
export KUBECONFIG=/root/stacks/terraform/bastille/ansible/playbooks/autogenerated/rke2-vip.yaml

# install kube-vip
ansible-playbook ./playbooks/kube-vip.yml --user root -i ./inventory/hosts

# install rke2 on the remaining master nodes, sequentially
ansible-playbook ./playbooks/rke2-add-server.yml --user root -i ./inventory/hosts -l 10.30.0.11
ansible-playbook ./playbooks/rke2-add-server.yml --user root -i ./inventory/hosts -l 10.30.0.12

# install rke2 on agents
ansible-playbook ./playbooks/rke2-add-nodes.yml --user root -i ./inventory/hosts

# install metallb and cert-manager
ansible-playbook ./playbooks/metallb.yml --user root -i ./inventory/hosts
ansible-playbook ./playbooks/cert-manager.yml --user root -i ./inventory/hosts

# Install Rancher
helm repo add rancher-latest https://releases.rancher.com/server-charts/latest
kubectl create namespace cattle-system
helm install rancher rancher-latest/rancher \
 --namespace cattle-system \
 --set hostname=rancher.k8s.dcnt.company \
 --set bootstrapPassword=admin \
 --set ingress.tls.source=letsEncrypt \
 --set letsEncrypt.email=jonathan22711@gmail.com \
 --set letsEncrypt.ingress.class=traefik

kubectl -n cattle-system rollout status deploy/rancher
kubectl -n cattle-system get deploy rancher

ansible-galaxy collection install community.general
ansible-galaxy collection install kubernetes.core
ansible-playbook ./playbooks/traefik.yml --user root -i ./inventory/hosts

```
