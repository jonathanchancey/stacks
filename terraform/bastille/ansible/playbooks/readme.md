# ansible

## commands

```bash
# these commands are for an admin vm/lxc on the same vlan as the cluster

# clone and cd into ansible dir
git clone https://github.com/jonathanchancey/stacks 
cd stacks/terraform/bastille/ansible/

# install first server and generate node-token and rke2.yaml
ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook ./playbooks/rke2-install-server.yml --user root -i ./inventory/hosts

# make token readable in ansible
echo -n "TOKEN: " | cat - ./playbooks/autogenerated/node-token > ./playbooks/autogenerated/token

# split out multiple kubeconfigs for different stages of cluster creation
cat ./playbooks/autogenerated/rke2.yaml | sed 's/127.0.0.1/'10.30.0.10'/g' > ./playbooks/autogenerated/rke2-initial.yaml
cat ./playbooks/autogenerated/rke2.yaml | sed 's/127.0.0.1/'10.30.0.30'/g' > ./playbooks/autogenerated/rke2-vip.yaml

# add to bashrc
export KUBECONFIG=/root/stacks/terraform/bastille/ansible/playbooks/autogenerated/rke2-vip.yaml

# install kube-vip
ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook ./playbooks/kube-vip.yml --user root -i ./inventory/hosts

# install rke2 on the remaining master nodes, sequentially
ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook ./playbooks/rke2-add-server.yml --user root -i ./inventory/hosts -l 10.30.0.11
ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook ./playbooks/rke2-add-server.yml --user root -i ./inventory/hosts -l 10.30.0.12

# install rke2 on agents
ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook ./playbooks/rke2-add-nodes.yml --user root -i ./inventory/hosts

# install metallb and cert-manager
ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook ./playbooks/metallb.yml --user root -i ./inventory/hosts
ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook ./playbooks/cert-manager.yml --user root -i ./inventory/hosts
```
