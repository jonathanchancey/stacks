- name: install rke2 on nodes
  hosts: agent
  vars_files:
  - ../inventory/group_vars/env.yml
  - ./autogenerated/node-token

  tasks:
    - name: update repositories cache and install qemu-guest-agent and containerd package
      ansible.builtin.apt:
        pkg:
          - qemu-guest-agent
          - containerd
        update_cache: yes
    - name: create directories if they don't exist
      file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: 0755
        recurse: yes
      loop:
        - "{{ CONFDIR }}"
    - name: get hostname short
      shell: |
        hostname -s
      register: hostname_short
    - name: get hostname fqdn
      shell: |
        hostname -f
      register: hostname_fqdn
    - name: print hostname fqdn and short
      debug:
        msg:
        - "hostname short '{{ hostname_short.stdout }}'"
        - "hostname fqdn: '{{ hostname_fqdn.stdout }}'"
    - name: create config.yaml
      copy:
        dest: "{{ CONFFILE }}"
        content: |
          token: {{ TOKEN }}
          server: https://{{ SERVER_ADDRESS_FQDN }}:9345
    - name: install rke2 agent
      become: true
      shell: |
        curl -sfL https://get.rke2.io | INSTALL_RKE2_TYPE="agent" INSTALL_RKE2_VERSION="{{INSTALL_RKE2_VERSION }}" sh -
      notify: "rke2-agent service start"
    - name: add rke2 dir to PATH.
      copy:
        dest: /etc/profile.d/custom-path.sh
        content: 'PATH=$PATH:/opt/rke2/bin'
  handlers:
    - name: ensure rke2-agent is running
      systemd:
        state: started
        name: rke2-agent
      listen: "rke2-agent service start"
    - name: ensure rke2-agent is restarted
      systemd:
        state: restarted
        name: rke2-agent
      listen: "rke2-agent service restart"
