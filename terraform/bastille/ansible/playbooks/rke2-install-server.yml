- name: install rke2
  hosts: "server"
  tasks:
    - name: Update repositories cache and install "qemu-guest-agent" package
      ansible.builtin.apt:
        name: qemu-guest-agent
        update_cache: yes
    - name: install rke2 server
      become: true
      command: bash -c 'curl -sfL https://get.rke2.io | sh -'
    - name: add rke2 to path
      become: true
      command: bash -c 'export PATH=$PATH:/opt/rke2/bin'
    - name: enable rke2-server service
      become: true
      command: bash -c 'systemctl enable rke2-server.service'
    - name: start rke2-server service
      become: true
      command: bash -c 'systemctl start rke2-server.service'
    - name: obtain node-token
      ansible.builtin.fetch:
        src: /var/lib/rancher/rke2/server/node-token
        dest: autogenerated/node-token
        flat: yes
    - name: Find out what the remote machine's mounts are
      ansible.builtin.slurp:
        src: /var/lib/rancher/rke2/server/node-token
      register: node-token
    - name: Print returned information
      ansible.builtin.debug:
        msg: "{{ mounts['content']}}"
    - name: Print returned information
      ansible.builtin.debug:
        msg: "{{ mounts['content'] | b64decode }}"
