---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: zitadel
spec:
  interval: 1h
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  chart:
    spec:
      chart: zitadel
      version: 8.0.0
      sourceRef:
        kind: HelmRepository
        name: zitadel
        namespace: auth-system
  valuesFrom:
    - kind: Secret
      name: zitadel-secret
      valuesKey: postgres-user-password
      targetPath: zitadel.secretConfig.Database.Postgres.User.Password
    - kind: Secret
      name: zitadel-init-db-secret
      valuesKey: INIT_POSTGRES_SUPER_PASS
      targetPath: zitadel.secretConfig.Database.Postgres.Admin.Password
    - kind: Secret
      name: zitadel-secret
      valuesKey: masterkey
      targetPath: zitadel.masterkey
    - kind: Secret
      name: zitadel-secret
      valuesKey: smtp-host
      targetPath: zitadel.configmapConfig.SMTPConfiguration.SMTP.Host
    - kind: Secret
      name: zitadel-secret
      valuesKey: smtp-password
      targetPath: zitadel.configmapConfig.SMTPConfiguration.SMTP.Password
  values:
    replicaCount: 1
    login:
      enabled: false
    zitadel:
      configmapConfig:
        ServicePing:
          Enabled: false
          Telemetry:
            ResourceCounts:
              Enabled: false
        SMTPConfiguration:
          From: admin@chancey.dev
          FromName: admin@chancey.dev
          ReplyToAddress: admin@chancey.dev
          SMTP:
            User: admin@chancey.dev
          TLS: true
        ExternalSecure: true
        ExternalPort: 443
        ExternalDomain: auth.chancey.dev
        TLS:
          Enabled: false
        Database:
          Postgres:
            Host: bastille-pg-rw.database.svc.cluster.local
            Port: 5432
            Database: zitadel
            MaxOpenConns: 20
            MaxIdleConns: 10
            MaxConnLifetime: 30m
            MaxConnIdleTime: 5m
            User:
              Username: zitadel
              SSL:
                Mode: disable
            Admin:
              Username: postgres
              SSL:
                Mode: disable
